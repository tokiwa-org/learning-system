# ワークフロー設計

本ドキュメントは、人事考課システムの評価ワークフローとCloudflare
Workflowsによる実装を定義します。

---

## 1. 評価サイクル状態遷移

### 1.1 状態一覧（2025年度改訂版）

> **変更履歴**: 2025年度より、自己評価・同僚評価を廃止し、自動レポート生成ベースのワークフローに移行

| 状態                 | 説明                     | 次の状態                   |
| -------------------- | ------------------------ | -------------------------- |
| `REPORT_GENERATED`   | レポート自動生成済（初期）| MANAGER_EVALUATED          |
| `MANAGER_EVALUATED`  | 上司評価完了             | MANAGER_APPROVED, REJECTED |
| `MANAGER_APPROVED`   | 上司承認済み             | HR_APPROVED, REJECTED      |
| `HR_APPROVED`        | HR承認済み               | FINALIZED                  |
| `FINALIZED`          | 確定（最終状態）         | -                          |
| `REJECTED`           | 差戻し                   | 前の状態へ                 |

#### 廃止された状態（旧ワークフロー）
- `DRAFT` - 下書き不要（レポート自動生成のため）
- `SELF_SUBMITTED` - 自己評価廃止
- `PEER_COMPLETED` - 同僚評価廃止

### 1.2 状態遷移図

```
[評価期間ACTIVE]
       │
       ▼ (自動)
┌────────────────────┐
│  REPORT_GENERATED  │  システムが自動生成
│  (レポート生成済み)  │
└─────────┬──────────┘
          │ 上司が評価入力
          ▼
┌────────────────────┐
│ MANAGER_EVALUATED  │  上司がスコア入力・調整
│   (上司評価済み)    │
└─────────┬──────────┘
          │ 上司が承認
          ▼
┌────────────────────┐
│  MANAGER_APPROVED  │  上司承認完了
│   (上司承認済み)    │◄──────────────┐
└─────────┬──────────┘               │
          │ HR承認                   │ 差戻しループ
          ▼                         │
┌────────────────────┐              │
│    HR_APPROVED     │  HR承認完了   │
│    (HR承認済み)     │──────────────┘
└─────────┬──────────┘
          │ 確定処理
          ▼
┌────────────────────┐
│     FINALIZED      │  給与反映
│       (確定)       │
└────────────────────┘

    ┌──────────┐
    │ REJECTED │  差戻し状態
    │  (差戻)   │  → 該当者が修正後、再提出
    └──────────┘
```

### 1.3 状態遷移アクション

| アクション                   | From               | To                 | 実行者   |
| ---------------------------- | ------------------ | ------------------ | -------- |
| `generateReport`             | (期間開始)          | REPORT_GENERATED   | システム |
| `submitManagerEvaluation`    | REPORT_GENERATED   | MANAGER_EVALUATED  | 上司     |
| `approveByManager`           | MANAGER_EVALUATED  | MANAGER_APPROVED   | 上司     |
| `approveByHR`                | MANAGER_APPROVED   | HR_APPROVED        | HR       |
| `finalize`                   | HR_APPROVED        | FINALIZED          | HR       |
| `reject`                     | MANAGER_EVALUATED/MANAGER_APPROVED/HR_APPROVED | REJECTED | 上司/HR  |
| `resubmit`                   | REJECTED           | 前の状態           | 該当者   |

---

## 2. Cloudflare Workflows 設計

### 2.1 ワークフロー概要（新ワークフロー）

```typescript
// evaluation-workflow.ts
import { WorkflowEntrypoint, WorkflowStep, WorkflowEvent } from 'cloudflare:workers';

interface EvaluationWorkflowInput {
  cycleId: string;
  periodId: string;
  employeeId: string;
}

export class EvaluationWorkflow extends WorkflowEntrypoint<Env, EvaluationWorkflowInput> {
  async run(event: WorkflowEvent<EvaluationWorkflowInput>, step: WorkflowStep) {
    const { cycleId, periodId, employeeId } = event.payload;

    // Step 1: 達成度レポート自動生成
    await this.generateAchievementReport(step, cycleId, employeeId);

    // Step 2: 上司評価待ち
    await this.waitForManagerEvaluation(step, cycleId);

    // Step 3: 上司承認待ち
    await this.waitForManagerApproval(step, cycleId);

    // Step 4: HR承認待ち
    await this.waitForHRApproval(step, cycleId);

    // Step 5: 確定処理
    await this.finalize(step, cycleId);
  }
}
```

### 2.2 各ステップの詳細

#### Step 1: 達成度レポート自動生成（新規）

```typescript
async generateAchievementReport(step: WorkflowStep, cycleId: string, employeeId: string) {
  await step.do('generate-achievement-report', async () => {
    // 1. 社員情報取得（職級、号俸、給与）
    const employee = await this.employeeService.getWithGrade(employeeId);

    // 2. ロードマップ達成状況取得
    const achievements = await this.roadmapService.getAchievements(
      employeeId,
      employee.gradeId
    );

    // 3. スコア自動計算
    const scores = this.calculateScores(achievements);
    // - スキル習得度: 50点満点（No.1-46）
    // - 職能発揮力: 30点満点（No.52-73）
    // - 行動・貢献: 20点満点（No.74-82）

    // 4. 推奨ランク算出
    const suggestedRank = this.determineRank(scores.total);

    // 5. レポート保存
    await this.reportService.create({
      cycleId,
      employeeId,
      ...employee,
      ...achievements,
      ...scores,
      suggestedRank,
    });

    // 6. ステータス更新
    await this.cycleService.updateStatus(cycleId, 'REPORT_GENERATED');
  });

  // 上司に通知
  await step.do('notify-manager', async () => {
    const manager = await this.cycleService.getManager(cycleId);
    await this.notificationService.send({
      type: 'ACHIEVEMENT_REPORT_READY',
      cycleId,
      managerId: manager.id,
    });
  });
}
```

#### Step 2: 上司評価待ち

```typescript
async waitForManagerEvaluation(step: WorkflowStep, cycleId: string) {
  // 上司評価提出を待機
  await step.waitForEvent<ManagerEvaluationSubmittedEvent>(
    'manager-evaluation-submitted',
    {
      timeout: '14 days',
    }
  );

  // ステータス更新
  await step.do('update-status-manager-evaluated', async () => {
    await this.cycleService.updateStatus(cycleId, 'MANAGER_EVALUATED');
  });
}
```

#### Step 3: 上司承認待ち

```typescript
async waitForManagerApproval(step: WorkflowStep, cycleId: string) {
  let approved = false;

  while (!approved) {
    // 承認/差戻しを待機
    const result = await step.waitForEvent<ApprovalEvent>(
      'manager-approval-decision',
      {
        timeout: '7 days',
      }
    );

    if (result.action === 'APPROVE') {
      approved = true;
      await step.do('update-status-manager-approved', async () => {
        await this.cycleService.updateStatus(cycleId, 'MANAGER_APPROVED');
      });
    } else if (result.action === 'REJECT') {
      // 差戻し処理
      await step.do('handle-rejection', async () => {
        await this.cycleService.updateStatus(cycleId, 'REJECTED');
        await this.notificationService.send({
          type: 'EVALUATION_REJECTED',
          cycleId,
          comment: result.comment,
        });
      });

      // 修正後の再提出を待機
      await step.waitForEvent<ResubmittedEvent>('resubmitted', {
        timeout: '14 days',
      });
    }
  }
}
```

#### Step 4: HR承認待ち

```typescript
async waitForHRApproval(step: WorkflowStep, cycleId: string) {
  // HR担当者に通知
  await step.do('notify-hr-approval', async () => {
    await this.notificationService.send({
      type: 'HR_APPROVAL_REQUEST',
      cycleId,
    });
  });

  let approved = false;

  while (!approved) {
    const result = await step.waitForEvent<ApprovalEvent>(
      'hr-approval-decision',
      {
        timeout: '14 days',
      }
    );

    if (result.action === 'APPROVE') {
      approved = true;
      await step.do('update-status-hr-approved', async () => {
        await this.cycleService.updateStatus(cycleId, 'HR_APPROVED');
      });
    } else if (result.action === 'REJECT') {
      // 上司へ差戻し
      await step.do('handle-hr-rejection', async () => {
        await this.cycleService.updateStatus(cycleId, 'MANAGER_APPROVED'); // 戻す
        await this.notificationService.send({
          type: 'EVALUATION_REJECTED_BY_HR',
          cycleId,
          comment: result.comment,
        });
      });

      // 再承認を待機
      await this.waitForManagerApproval(step, cycleId);
    }
  }
}
```

#### Step 5: 確定処理

```typescript
async finalize(step: WorkflowStep, cycleId: string) {
  await step.do('finalize-evaluation', async () => {
    // 1. 最終スコア取得（上司調整後）
    const report = await this.reportService.get(cycleId);

    // 2. 最終ランク取得
    const finalRank = report.finalRank;

    // 3. 昇給額計算
    const salaryIncrement = this.salaryService.calculateIncrement(finalRank);

    // 4. DB更新（給与反映）
    await this.cycleService.finalize(cycleId, {
      finalScore: report.totalScoreAdjusted,
      finalRank,
      salaryIncrement,
    });

    // 5. ステータス更新
    await this.cycleService.updateStatus(cycleId, 'FINALIZED');

    // 6. 本人に通知（この時点で初めて結果閲覧可能）
    await this.notificationService.send({
      type: 'EVALUATION_FINALIZED',
      cycleId,
    });
  });
}
```

### 2.3 スコア計算ロジック

```typescript
interface ScoreCalculation {
  skillScore: number;         // 最大50点
  competencyScore: number;    // 最大30点
  behaviorScore: number;      // 最大20点
  totalScore: number;         // 最大100点
}

function calculateScores(achievements: AchievementData): ScoreCalculation {
  // スキル習得度（No.1-46）: 50点満点
  const skillScore = calculateAxisScore(
    achievements.items.filter(i => i.axisCode === 'SKILL'),
    50
  );

  // 職能発揮力（No.52-73）: 30点満点
  const competencyScore = calculateAxisScore(
    achievements.items.filter(i => i.axisCode === 'COMPETENCY'),
    30
  );

  // 行動・貢献（No.74-82）: 20点満点
  const behaviorScore = calculateAxisScore(
    achievements.items.filter(i => i.axisCode === 'BEHAVIOR'),
    20
  );

  return {
    skillScore,
    competencyScore,
    behaviorScore,
    totalScore: skillScore + competencyScore + behaviorScore,
  };
}

function calculateAxisScore(items: AchievementItem[], maxScore: number): number {
  const achievedCount = items.filter(i => i.status === 'ACHIEVED').length;
  const totalCount = items.length;
  return totalCount > 0 ? (achievedCount / totalCount) * maxScore : 0;
}
```

### 2.4 ランク判定

| 合計点    | ランク | 昇給率 |
| --------- | ------ | ------ |
| 95点以上  | S      | +5%    |
| 85点以上  | A      | +3%    |
| 70点以上  | B      | +1%    |
| 55点以上  | C      | ±0%    |
| 55点未満  | D      | -1%    |

```typescript
function determineRank(totalScore: number): EvaluationRank {
  if (totalScore >= 95) return 'S';
  if (totalScore >= 85) return 'A';
  if (totalScore >= 70) return 'B';
  if (totalScore >= 55) return 'C';
  return 'D';
}
```

### 2.5 イベント送信

```typescript
// ワークフローへのイベント送信
async function sendWorkflowEvent(
  cycleId: string,
  eventType: string,
  payload: any
) {
  const workflowInstance = await env.EVALUATION_WORKFLOW.get(cycleId);
  await workflowInstance.sendEvent({
    type: eventType,
    payload,
  });
}

// API側での使用例（上司評価提出）
app.post('/cycles/:cycleId/manager-evaluation/submit', async (c) => {
  const { cycleId } = c.req.param();
  const { adjustedScores, finalRank, comments } = await c.req.json();

  // 評価データ保存
  await reportService.updateManagerEvaluation(cycleId, {
    skillScoreAdjusted: adjustedScores.skillScore,
    competencyScoreAdjusted: adjustedScores.competencyScore,
    behaviorScoreAdjusted: adjustedScores.behaviorScore,
    finalRank,
    managerComments: comments,
  });

  // ワークフローにイベント送信
  await sendWorkflowEvent(cycleId, 'manager-evaluation-submitted', {
    submittedAt: new Date().toISOString(),
  });

  return c.json({ success: true });
});
```

---

## 3. 通知設計

### 3.1 通知タイプ（新ワークフロー対応）

| タイプ                       | トリガー             | 宛先   | メッセージ例                           |
| ---------------------------- | -------------------- | ------ | -------------------------------------- |
| `ACHIEVEMENT_REPORT_READY`   | レポート自動生成完了 | 上司   | 「田中さんの達成度レポートが生成されました」 |
| `MANAGER_EVALUATION_REMINDER`| 上司評価未完了       | 上司   | 「評価の入力をお願いします」           |
| `MANAGER_APPROVAL_REQUEST`   | 上司評価提出後       | 上司   | 「評価を承認してください」             |
| `HR_APPROVAL_REQUEST`        | 上司承認後           | HR     | 「評価を確認してください」             |
| `EVALUATION_REJECTED`        | 差戻し時             | 該当者 | 「評価が差し戻されました」             |
| `EVALUATION_FINALIZED`       | 確定時               | 本人   | 「評価結果が確定しました」             |

> **廃止された通知タイプ**:
> - `SELF_EVALUATION_START` - 自己評価廃止
> - `PEER_EVALUATION_REQUEST` - 同僚評価廃止

### 3.2 通知チャネル

| チャネル     | 用途                       |
| ------------ | -------------------------- |
| アプリ内通知 | 全ての通知                 |
| Google Chat  | 重要な通知（差戻し、確定） |
| メール       | オプション                 |

---

## 4. 社員の閲覧制限

### 4.1 閲覧権限ルール

| ステータス         | 社員本人の閲覧 | 表示内容                 |
| ------------------ | -------------- | ------------------------ |
| REPORT_GENERATED   | ✗              | 「評価プロセス進行中」   |
| MANAGER_EVALUATED  | ✗              | 「評価プロセス進行中」   |
| MANAGER_APPROVED   | ✗              | 「評価プロセス進行中」   |
| HR_APPROVED        | ✗              | 「評価プロセス進行中」   |
| FINALIZED          | ✓              | スコア・ランク・コメント |

### 4.2 実装

```typescript
// API: レポート取得
app.get('/cycles/:cycleId/report', async (c) => {
  const { cycleId } = c.req.param();
  const user = c.get('user');

  const cycle = await cycleService.get(cycleId);

  // 社員本人の場合、FINALIZEDでないと403
  if (user.role === 'EMPLOYEE' && cycle.status !== 'FINALIZED') {
    return c.json({
      success: false,
      error: {
        code: 'REPORT_NOT_AVAILABLE',
        message: '評価結果は確定後に閲覧できます',
      },
    }, 403);
  }

  // 上司・HR・ADMINは閲覧可能
  const report = await reportService.get(cycleId);
  return c.json({ success: true, data: report });
});
```

---

## 5. 期間管理

### 5.1 評価期間の自動処理

```typescript
// 評価期間開始時（Cronトリガーまたは手動）
async function activateEvaluationPeriod(periodId: string) {
  // 1. 対象社員取得
  const employees = await db.query(
    'SELECT * FROM employees WHERE status = ?',
    ['ACTIVE']
  );

  // 2. 全社員分のサイクルとワークフロー作成
  for (const employee of employees) {
    // 評価サイクル作成
    const cycleId = await createEvaluationCycle(periodId, employee.id);

    // ワークフローインスタンス作成・開始
    await env.EVALUATION_WORKFLOW.create({
      id: cycleId,
      params: {
        cycleId,
        periodId,
        employeeId: employee.id,
      },
    });
  }

  // 3. 期間ステータス更新
  await periodService.updateStatus(periodId, 'ACTIVE');
}
```

### 5.2 期限設定

| ステップ     | 目安期限     | リマインダー |
| ------------ | ------------ | ------------ |
| 上司評価     | 評価月の14日 | 3日前、1日前 |
| 上司承認     | 評価月の21日 | 3日前        |
| HR確定       | 評価月末     | -            |

---

## 6. エラーハンドリング

### 6.1 タイムアウト処理

```typescript
async waitForManagerEvaluation(step: WorkflowStep, cycleId: string) {
  try {
    await step.waitForEvent('manager-evaluation-submitted', {
      timeout: '14 days',
    });
  } catch (error) {
    if (error instanceof TimeoutError) {
      // 期限超過通知
      await this.notificationService.send({
        type: 'DEADLINE_EXCEEDED',
        cycleId,
        step: 'MANAGER_EVALUATION',
      });

      // 管理者に通知
      await this.notificationService.notifyAdmins({
        type: 'DEADLINE_EXCEEDED_ADMIN',
        cycleId,
      });

      // 待機継続（管理者対応待ち）
      await step.waitForEvent('admin-action', {
        timeout: '365 days',
      });
    }
  }
}
```

---

## 7. 監査ログ

### 7.1 記録対象

| アクション     | 記録内容                               |
| -------------- | -------------------------------------- |
| レポート生成   | cycleId, employeeId, scores            |
| 状態遷移       | cycleId, fromStatus, toStatus, actorId |
| スコア調整     | cycleId, originalScore, adjustedScore  |
| 承認/差戻し    | cycleId, action, comment, actorId      |
| 確定           | cycleId, finalScore, finalRank         |

---

## 8. カリキュラム作成ワークフロー

### 8.1 概要

人事/有識者が文章題（シナリオ）を作成し、LLMでカリキュラムを自動生成するワークフロー。

### 8.2 状態遷移

| 状態        | 説明               | 次の状態                 |
| ----------- | ------------------ | ------------------------ |
| `DRAFT`     | シナリオ下書き     | GENERATED                |
| `GENERATED` | カリキュラム生成済 | REVIEWED, DRAFT(修正時)  |
| `REVIEWED`  | 有識者査閲完了     | PUBLISHED, DRAFT(修正時) |
| `PUBLISHED` | 配信完了（最終）   | -                        |

### 8.3 状態遷移図

```
┌──────────┐   シナリオ作成    ┌───────────┐   LLM生成    ┌───────────┐
│  DRAFT   │ ───────────────► │ GENERATED │ ──────────► │ REVIEWED  │
│ (下書き)  │ ◄─────────────── │ (生成済み) │ ◄────────── │ (査閲済み) │
└──────────┘    修正依頼       └───────────┘   修正依頼   └─────┬─────┘
                                                              │ 承認
                                                              ▼
                                                        ┌───────────┐
                                                        │ PUBLISHED │
                                                        │  (配信)    │
                                                        └───────────┘
```

---

_トキワテック人事考課システム 2025年度版_

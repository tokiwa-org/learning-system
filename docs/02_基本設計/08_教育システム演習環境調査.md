# 教育システム演習環境の提供方式調査

## 概要

教育プラットフォームが演習環境をどのように提供しているかの技術調査結果。

---

## 1. 演習環境の提供パターン

### パターン一覧

| パターン | 代表例 | 特徴 | 適用場面 |
|---------|--------|------|---------|
| **A. ブラウザ内実行** | Codecademy, v86 | サーバー不要、完全クライアント側 | 初学者向け、簡単なコード実行 |
| **B. サーバーサイド実行** | LeetCode, HackerRank | コンテナで隔離実行 | 本格的なコード評価、テスト実行 |
| **C. クラウドサンドボックス** | AWS Cloud Quest, Katacoda | 実クラウド環境を提供 | インフラ・クラウド学習 |
| **D. ハイブリッド** | Replit, CodeSandbox | ブラウザ+サーバー併用 | フルスタック開発学習 |

---

## 2. パターン詳細

### A. ブラウザ内実行型

```
┌─────────────────────────────────────────────────┐
│                   ブラウザ                       │
│  ┌─────────────────────────────────────────────┐│
│  │  xterm.js (ターミナルUI)                    ││
│  │       ↕                                     ││
│  │  Wasm Runtime / v86 / WebContainers         ││
│  │       ↕                                     ││
│  │  仮想ファイルシステム                        ││
│  └─────────────────────────────────────────────┘│
└─────────────────────────────────────────────────┘
         ※ サーバー通信なし
```

**技術スタック:**
- **ターミナルUI**: xterm.js
- **実行環境**:
  - v86 (x86エミュレータ) - Linux OS全体を実行可能
  - WebAssembly (Wasm) - 高速だが制限あり
  - WebContainers (StackBlitz) - Node.js特化

**メリット:**
- サーバーコスト $0
- オフライン動作可能
- 即時起動（Cold Startなし）
- セキュリティリスク最小

**デメリット:**
- 実行環境に制限あり
- パフォーマンスはネイティブより劣る

**採用プラットフォーム:**
- Codecademy（一部コース）
- StackBlitz
- Wasmer Playground

---

### B. サーバーサイド実行型

```
┌─────────────────────────────────────────────────┐
│  ブラウザ                                        │
│  ┌────────────┐    WebSocket    ┌─────────────┐ │
│  │ xterm.js   │ ←────────────→ │ サーバー     │ │
│  │ Monaco     │                 │             │ │
│  └────────────┘                 └─────────────┘ │
└─────────────────────────────────────────────────┘
                                        ↓
                    ┌─────────────────────────────────┐
                    │        Docker/Container Pool     │
                    │  ┌──────┐ ┌──────┐ ┌──────┐     │
                    │  │Python│ │Node  │ │Go    │ ... │
                    │  │ 環境 │ │ 環境 │ │ 環境 │     │
                    │  └──────┘ └──────┘ └──────┘     │
                    └─────────────────────────────────┘
```

**アーキテクチャ（LeetCode方式）:**

1. **メッセージキュー**: 提出スパイクを吸収
2. **Warm Pool戦略**: 事前起動済みコンテナをプール
3. **サンドボックス**: cgroups + seccomp で隔離
4. **リソース制限**: 時間・メモリ・CPU制限

**セキュリティ対策:**
```
- Linux namespaces: プロセス隔離
- cgroups: リソース制限（512MB RAM, 1 CPU等）
- seccomp: システムコール制限
- ネットワーク隔離: VPC/ファイアウォール
- ファイルシステム制限: 読み取り専用マウント
```

**実行フロー:**
```
1. ユーザーがコード提出
2. メッセージキューに投入
3. ワーカーがWarm Poolからコンテナ取得（即時）
4. コンテナ内でコード実行
5. 結果を比較・判定
6. コンテナをクリーンアップしてプールに返却
```

**採用プラットフォーム:**
- LeetCode
- HackerRank
- Codeforces
- AtCoder

---

### C. クラウドサンドボックス型

```
┌─────────────────────────────────────────────────┐
│  ブラウザ                                        │
│  ┌────────────────────────────────────────────┐ │
│  │  学習コンテンツ  │  ターミナル/コンソール    │ │
│  │  ・動画          │  ・実クラウド環境接続     │ │
│  │  ・ドキュメント  │  ・AWS/GCP/Azure         │ │
│  └────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
                         ↓
         ┌─────────────────────────────────────┐
         │    サンドボックスAWSアカウント       │
         │    ・一時的なIAMロール               │
         │    ・リソース制限あり                │
         │    ・自動クリーンアップ              │
         └─────────────────────────────────────┘
```

**AWS Cloud Quest の4ステップ方式:**

| ステップ | 内容 | 目的 |
|---------|------|------|
| 1. Learn | アーキテクチャ図、解説動画 | 概念理解 |
| 2. Plan | ソリューション設計 | 思考の整理 |
| 3. Practice | ガイド付きハンズオン | 手順学習 |
| 4. DIY | 自力で構築 | 定着確認 |

**特徴:**
- 実際のクラウド環境を使用
- サンドボックスアカウントは自動生成・自動削除
- 課金はプラットフォーム側が負担

**採用プラットフォーム:**
- AWS Cloud Quest / AWS Jam
- Google Cloud Skills Boost
- Microsoft Learn (Azure Sandbox)
- Katacoda / Killercoda (Kubernetes)

---

### D. ハイブリッド型

```
┌─────────────────────────────────────────────────┐
│  ブラウザ                                        │
│  ┌────────────────────────────────────────────┐ │
│  │  Monaco Editor     │  プレビュー            │ │
│  │  (コードエディタ)   │  (iframe)             │ │
│  │        ↕           │       ↕               │ │
│  │  WebContainers     │  Hot Reload            │ │
│  │  (ブラウザ内Node)  │                        │ │
│  └────────────────────────────────────────────┘ │
│                                                  │
│  ※ 重い処理のみサーバーに委譲                    │
└─────────────────────────────────────────────────┘
```

**採用プラットフォーム:**
- Replit
- CodeSandbox
- Glitch

---

## 3. ターミナルUI実装

### xterm.js 採用プラットフォーム

| プラットフォーム | 用途 |
|----------------|------|
| **VS Code** | 統合ターミナル |
| **Codecademy** | Bashコース |
| **Replit** | ブラウザIDE |
| **Katacoda / Killercoda** | K8s学習 |
| **Next Tech** | コンテナバックエンド接続 |
| **CodeInterview.io** | コーディング面接 |
| **CoderPad** | コーディング面接 |

### xterm.js 実装パターン

#### パターン1: WebSocket + node-pty

```
ブラウザ                         サーバー
┌──────────┐    WebSocket    ┌──────────────┐
│ xterm.js │ ←─────────────→ │ node-pty     │
│          │   キー入力/出力  │ (疑似TTY)    │
└──────────┘                 └──────────────┘
                                    ↓
                             ┌──────────────┐
                             │ /bin/bash    │
                             └──────────────┘
```

#### パターン2: Wasm + xterm.js

```
ブラウザ
┌────────────────────────────────────┐
│  xterm.js                          │
│      ↕ (in-process)                │
│  @wasmer/sdk                       │
│      ↕                             │
│  Wasm Runtime (bash.wasm)          │
└────────────────────────────────────┘
    ※ 完全にブラウザ内で完結
```

#### パターン3: v86 + xterm.js

```
ブラウザ
┌────────────────────────────────────┐
│  xterm.js                          │
│      ↕                             │
│  v86 (x86エミュレータ)             │
│      ↕                             │
│  Linux Kernel                      │
│      ↕                             │
│  /bin/bash + coreutils             │
└────────────────────────────────────┘
```

#### パターン4: container2wasm + xterm.js（推奨）

```
ブラウザ
┌────────────────────────────────────┐
│  xterm.js                          │
│      ↕                             │
│  container2wasm (Bochs/TinyEMU)    │
│      ↕                             │
│  Linux Kernel + runc               │
│      ↕                             │
│  Docker Container (debian等)       │
└────────────────────────────────────┘
```

**container2wasm の特徴:**
- Dockerイメージをそのまま Wasm に変換可能
- x86_64 は Bochs、RISC-V は TinyEMU でエミュレート
- 既存のDockerイメージ資産を活用可能
- [デモ](https://ktock.github.io/container2wasm-demo/) - debian, python, node, vim

---

## 4. ゲーミフィケーション要素

### AWS Cloud Quest スタイル

| 要素 | 実装方法 |
|------|---------|
| **ミッション形式** | ストーリー性のある課題提示 |
| **アバター** | ユーザーの分身となるキャラクター |
| **3D仮想都市** | 視覚的な没入感（※コスト高） |
| **進捗バッジ** | 完了時にCredly等でデジタルバッジ発行 |
| **ステップ進行** | Learn → Plan → Practice → DIY |

### シンプルなゲーミフィケーション

| 要素 | 実装方法 |
|------|---------|
| **ミッションタイトル** | 「〜を阻止せよ」「〜を解明しよう」 |
| **背景ストーリー** | 状況設定テキスト |
| **ステップ進行** | STEP 1/5 形式の進捗表示 |
| **チェックポイント** | 各ステップ完了時の確認 |
| **進捗バー** | 視覚的な進捗表示 |

---

## 5. 本プロジェクトへの適用

### 推奨アーキテクチャ（container2wasm方式）

```
┌─────────────────────────────────────────────────────────────────────────┐
│  LearningTerminal.tsx                                                    │
│  ┌────────────────────────┬────────────────────────────────────────────┐│
│  │  学習コンテンツ         │  ターミナル + エディタ                     ││
│  │  ・ミッション説明       │  ┌────────────────────────────────────────┐││
│  │  ・ステップガイド       │  │ xterm.js (Terminal UI)                 │││
│  │  ・コマンド参考         │  │     ↕                                  │││
│  │                        │  │ container2wasm (Blink)                 │││
│  │  [次のステップへ]      │  │ - ls, cd, grep 等のLinux標準操作       │││
│  │                        │  │ - 本物のバイナリで実行                  │││
│  │                        │  └────────────────────────────────────────┘││
│  └────────────────────────┴────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘
```

### 推奨技術スタック

| コンポーネント | 推奨技術 | 役割 |
|---------------|---------|------|
| **Terminal UI** | xterm.js | ユーザーが見る「黒い画面」 |
| **OS / Shell** | container2wasm (Blink) | ls, cd, grep などのLinux標準操作を本物のバイナリで提供 |
| **Code Runner** | Service Worker + esbuild-wasm | TSコードをブラウザ側で一瞬でコンパイルし、メインスレッドとは別で実行 |
| **File System** | SharedArrayBuffer / IndexedDB | ターミナルでの操作結果と、エディタでのコード編集を同期 |

### アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                        ブラウザ                              │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                    xterm.js                              ││
│  │                 (Terminal UI)                            ││
│  └──────────────────────┬──────────────────────────────────┘│
│                         │                                    │
│  ┌──────────────────────▼──────────────────────────────────┐│
│  │              container2wasm (Blink)                      ││
│  │         Bochs (x86_64) / TinyEMU (RISC-V)               ││
│  │                         │                                ││
│  │              ┌──────────▼──────────┐                     ││
│  │              │    Linux Kernel     │                     ││
│  │              │    + runc           │                     ││
│  │              └──────────┬──────────┘                     ││
│  │                         │                                ││
│  │              ┌──────────▼──────────┐                     ││
│  │              │  Docker Container   │                     ││
│  │              │  (debian/node/python)│                    ││
│  │              └─────────────────────┘                     ││
│  └─────────────────────────────────────────────────────────┘│
│                         │                                    │
│  ┌──────────────────────▼──────────────────────────────────┐│
│  │            SharedArrayBuffer / IndexedDB                 ││
│  │                 (File System 同期)                       ││
│  └─────────────────────────────────────────────────────────┘│
│                         │                                    │
│  ┌──────────────────────▼──────────────────────────────────┐│
│  │           Service Worker + esbuild-wasm                  ││
│  │              (TypeScript コンパイル)                     ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
         ※ 完全にブラウザ内で完結、サーバー通信なし
```

### v86 vs container2wasm 比較

| 項目 | v86 | container2wasm |
|------|-----|----------------|
| **エミュレータ** | 独自x86エミュレータ | Bochs (x86_64) / TinyEMU (RISC-V) |
| **コンテナ対応** | なし（ベアメタルLinux） | あり（Docker→Wasm変換） |
| **既存資産活用** | カスタムイメージ必要 | Dockerイメージをそのまま使用可能 |
| **ライセンス** | BSD-2 | Apache-2.0 |
| **成熟度** | 安定 | 実験的（experimental） |
| **デモ** | [copy.sh/v86](https://copy.sh/v86/) | [container2wasm-demo](https://ktock.github.io/container2wasm-demo/) |

### 採用判断

**container2wasm を推奨する理由:**
1. **Dockerイメージ活用**: 既存のnode, python, debian等のイメージをそのまま変換可能
2. **本物のバイナリ**: ls, cd, grep等が実際のLinuxバイナリとして動作
3. **拡張性**: 学習レベルに応じて異なるコンテナイメージを提供可能
4. **TypeScript統合**: esbuild-wasmと組み合わせてTS開発環境も構築可能

**注意点:**
- 実験的ソフトウェアのため、本番導入前に十分な検証が必要
- x86_64/RISC-V以外のアーキテクチャは追加エミュレーションで低速

### 次のステップ

1. **container2wasm PoC作成**
   - xterm.js + container2wasm 直接統合
   - debianコンテナでの基本動作確認

2. **学習用カスタムコンテナ作成**
   - L0用: bash + coreutils のみ
   - L1-L2用: + git, vim
   - L3-L5用: + node, python, npm

3. **ファイルシステム同期**
   - SharedArrayBuffer / IndexedDB での永続化
   - エディタとターミナルの連携

4. **コマンド検証機能**
   - 期待するコマンド/出力との比較
   - ステップ完了判定の自動化

---

## 参考資料

### 技術リソース
- [xterm.js](https://xtermjs.org/) - ブラウザターミナル
- [container2wasm](https://github.com/ktock/container2wasm) - Docker→Wasm変換
- [container2wasm デモ](https://ktock.github.io/container2wasm-demo/) - debian, python, node, vim
- [v86](https://github.com/copy/v86) - x86エミュレータ
- [Wasmer](https://wasmer.io/) - Wasmランタイム
- [esbuild-wasm](https://esbuild.github.io/) - ブラウザ内TypeScriptコンパイル

### 教育プラットフォーム参考
- [AWS Cloud Quest](https://aws.amazon.com/training/digital/immersive-learning/)
- [Killercoda](https://killercoda.com/)
- [Codecademy](https://www.codecademy.com/)
- [LeetCode System Design](https://www.hellointerview.com/learn/system-design/problem-breakdowns/leetcode)

### 実装参考
- [xterm.js + Node.js Tutorial](https://www.eddymens.com/blog/creating-a-browser-based-interactive-terminal-using-xtermjs-and-nodejs)
- [xterm.js + Wasmer](https://docs.wasmer.io/sdk/wasmer-js/tutorials/xterm-js)
- [LeetCode Sandbox Design](https://medium.com/@yashbudukh/building-a-remote-code-execution-system-9e55c5b248d6)

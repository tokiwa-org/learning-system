# インフラ構成設計

## 概要

本システムはCloudflareプラットフォーム上に構築されたサーバーレスアーキテクチャを採用しています。
Cloudflare Workers、D1 Database、Workflows、Queues、AI、KV Namespaceを組み合わせた統合環境です。

## アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Cloudflare Edge Network                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────┐     ┌─────────────────────────────────────────────┐ │
│  │  Cloudflare Access │────▶│              API Gateway Worker              │ │
│  │  (Entra ID SSO)    │     │         evaluation.tokiwa-tech.com          │ │
│  └────────────────────┘     └─────────────────────────────────────────────┘ │
│                                            │                                 │
│                    ┌───────────────────────┼───────────────────────┐        │
│                    │                       │                       │        │
│                    ▼                       ▼                       ▼        │
│  ┌─────────────────────────┐ ┌─────────────────────────┐ ┌─────────────────┐│
│  │   Evaluation Workflow   │ │   Curriculum Workflow   │ │   Batch Workers ││
│  │  (評価サイクル管理)     │ │  (カリキュラム生成)     │ │  (リマインダー) ││
│  └────────────┬────────────┘ └────────────┬────────────┘ └────────┬────────┘│
│               │                           │                       │         │
│               ▼                           ▼                       ▼         │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                         D1 Database (SQLite)                            ││
│  │                           evaluation-db                                 ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────────────────┐ │
│  │   Queue          │  │   KV Namespace   │  │      Cloudflare AI         │ │
│  │ (Notifications)  │  │     (Cache)      │  │  (LLM: Llama 3.1 8B)       │ │
│  └──────────────────┘  └──────────────────┘  └────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### 1. API Gateway Worker

**役割**: 全APIリクエストの受付とルーティング

| 設定項目 | 値 |
|---------|-----|
| Worker名 | `evaluation-api` |
| エントリポイント | `src/index.ts` |
| ルート | `evaluation.tokiwa-tech.com/api/*` |
| 互換性日付 | 2024-12-01 |

**機能**:
- Cloudflare Access認証の検証
- リクエストルーティング
- レスポンスフォーマット統一
- エラーハンドリング
- CORS処理

### 2. D1 Database

**役割**: 永続化データストレージ

| 環境 | データベース名 | 用途 |
|------|--------------|------|
| Production | `evaluation-db` | 本番データ |
| Staging | `evaluation-db-staging` | テストデータ |

**マイグレーション構成**:
```
database/migrations/
├── 0001_initial_schema.sql      # 基本テーブル
├── 0002_scenario_curriculum.sql  # シナリオ・カリキュラム
└── 0003_workflow_instances.sql   # ワークフロー管理
```

**特徴**:
- SQLiteベース
- エッジロケーションで低レイテンシ
- 自動バックアップ
- ポイントインタイムリカバリ

### 3. Cloudflare Workflows

#### 評価ワークフロー (EvaluationWorkflow)

**役割**: 評価サイクルの状態管理と自動進行

| 設定項目 | 値 |
|---------|-----|
| Workflow名 | `evaluation-workflow` |
| バインディング | `EVALUATION_WORKFLOW` |
| クラス名 | `EvaluationWorkflow` |

**ステップ**:
1. 初期化 (initialize)
2. 自己評価待ち (await-self-evaluation)
3. 同僚評価待ち (await-peer-evaluation)
4. 上司評価待ち (await-manager-evaluation)
5. 上司承認待ち (await-manager-approval)
6. HR承認待ち (await-hr-approval)
7. 確定処理 (finalize)

#### カリキュラムワークフロー (CurriculumWorkflow)

**役割**: カリキュラム自動生成と承認フロー

| 設定項目 | 値 |
|---------|-----|
| Workflow名 | `curriculum-workflow` |
| バインディング | `CURRICULUM_WORKFLOW` |
| クラス名 | `CurriculumWorkflow` |

**ステップ**:
1. シナリオ取得 (fetch-scenario)
2. カリキュラム生成 (generate-curriculum)
3. 有識者レビュー待ち (await-review)
4. 社員アサイン (assign-employees)
5. 完了 (complete)

### 4. Queues

**役割**: 非同期通知処理

| 設定項目 | 値 |
|---------|-----|
| Queue名 | `evaluation-notifications` |
| バインディング | `NOTIFICATION_QUEUE` |
| バッチサイズ | 10 |
| タイムアウト | 30秒 |

**通知タイプ**:
- `DEADLINE_REMINDER`: 期限リマインダー
- `APPROVAL_REQUEST`: 承認依頼
- `STATUS_CHANGE`: ステータス変更通知
- `CURRICULUM_ASSIGNED`: カリキュラム配信

### 5. KV Namespace

**役割**: セッションキャッシュ・一時データ

| 設定項目 | 値 |
|---------|-----|
| バインディング | `CACHE` |
| TTL | 3600秒 (1時間) |

**用途**:
- APIレスポンスキャッシュ
- セッションデータ
- レート制限カウンター

### 6. Cloudflare AI

**役割**: カリキュラム自動生成

| 設定項目 | 値 |
|---------|-----|
| バインディング | `AI` |
| モデル | `@cf/meta/llama-3.1-8b-instruct` |

**用途**:
- シナリオからのカリキュラム文章生成
- ノイズ付加（教育的誤情報）
- 学習コンテンツの多様化

## 認証・認可

### Cloudflare Access

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   ブラウザ      │────▶│ Cloudflare Access │────▶│  Entra ID       │
│                 │◀────│   (IdP Proxy)     │◀────│  (Azure AD)     │
└─────────────────┘     └──────────────────┘     └─────────────────┘
```

| 設定項目 | 値 |
|---------|-----|
| Team名 | `tokiwa-tech` |
| IdP | Microsoft Entra ID |
| 認証方式 | OAuth 2.0 / OIDC |

### JWT検証

```typescript
interface CFAccessJWT {
  aud: string[];      // Application Audience Tag
  email: string;      // ユーザーメールアドレス
  exp: number;        // 有効期限
  iat: number;        // 発行時刻
  iss: string;        // 発行者URL
  sub: string;        // ユーザーID
  identity_nonce: string;
  custom: {
    groups: string[]; // Entra IDグループ
  };
}
```

### ロールマッピング

| Entra IDグループ | アプリケーションロール | 権限 |
|-----------------|---------------------|------|
| `evaluation-employees` | EMPLOYEE | 自己評価、割当同僚評価 |
| `evaluation-managers` | MANAGER | + 部下評価、承認 |
| `evaluation-hr` | HR | + HR承認、昇格、シナリオ管理 |
| `evaluation-admins` | ADMIN | 全権限 |

## 環境構成

### Production

| 項目 | 値 |
|------|-----|
| ドメイン | `evaluation.tokiwa-tech.com` |
| D1 DB | `evaluation-db` |
| Workflow | `evaluation-workflow`, `curriculum-workflow` |
| Queue | `evaluation-notifications` |

### Staging

| 項目 | 値 |
|------|-----|
| ドメイン | `evaluation-staging.tokiwa-tech.com` |
| D1 DB | `evaluation-db-staging` |
| Workflow | `evaluation-workflow-staging`, `curriculum-workflow-staging` |
| Queue | `evaluation-notifications-staging` |

## バッチ処理

### リマインダーバッチ Worker

| 設定項目 | 値 |
|---------|-----|
| Worker名 | `evaluation-reminder-batch` |
| スケジュール | 毎日 09:00 JST, 10:00 JST |

**処理内容**:
1. 期限が近い評価タスクの検出
2. リマインダー通知のキューイング
3. 期限超過タスクのエスカレーション

### 通知処理 Worker

| 設定項目 | 値 |
|---------|-----|
| Worker名 | `evaluation-notification-worker` |
| トリガー | Queue Consumer |

**通知チャネル**:
- メール（外部API連携）
- Slack Webhook
- アプリ内通知（DB記録）

## シークレット管理

以下のシークレットは `wrangler secret put` で設定:

| シークレット名 | 用途 |
|--------------|------|
| `CF_ACCESS_AUD` | Cloudflare Access Audience Tag |
| `SLACK_WEBHOOK_URL` | Slack通知用Webhook |
| `EMAIL_API_KEY` | メール送信API キー |
| `SENTRY_DSN` | エラー監視（Sentry） |

```bash
# Production環境へのシークレット設定
wrangler secret put CF_ACCESS_AUD --env production
wrangler secret put SLACK_WEBHOOK_URL --env production
wrangler secret put EMAIL_API_KEY --env production

# Staging環境へのシークレット設定
wrangler secret put CF_ACCESS_AUD --env staging
wrangler secret put SLACK_WEBHOOK_URL --env staging
```

## デプロイメント

### デプロイフロー

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   開発      │────▶│    PR      │────▶│  Staging    │────▶│ Production  │
│  (local)    │     │  Review    │     │  Deploy     │     │  Deploy     │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                           │                   │                   │
                           ▼                   ▼                   ▼
                      CI テスト           自動デプロイ         手動承認
```

### デプロイコマンド

```bash
# ローカル開発
wrangler dev

# Staging環境へデプロイ
wrangler deploy --env staging

# Production環境へデプロイ
wrangler deploy --env production

# マイグレーション実行
wrangler d1 migrations apply evaluation-db --env production
wrangler d1 migrations apply evaluation-db-staging --env staging
```

### GitHub Actions ワークフロー

```yaml
# .github/workflows/deploy.yml
name: Deploy to Cloudflare

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy-staging:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: deploy --env staging

  deploy-production:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: deploy --env production
```

## 監視・ログ

### Cloudflare Analytics

- リクエスト数
- レスポンスタイム
- エラー率
- 地理的分布

### Workers Logs

```bash
# リアルタイムログ
wrangler tail --env production

# フィルタ付きログ
wrangler tail --env production --search "error"
```

### カスタムメトリクス

```typescript
// Workers Analytics Engine
env.ANALYTICS.writeDataPoint({
  blobs: ['evaluation', 'self-evaluation-submitted'],
  doubles: [responseTime],
  indexes: [employeeId],
});
```

## パフォーマンス最適化

### エッジキャッシュ

- 静的コンテンツ: Cache-Control ヘッダー
- 動的コンテンツ: KV Namespace キャッシュ

### D1 最適化

- インデックス設計（migrations参照）
- クエリの最適化
- 接続プーリング（Cloudflare管理）

### Workflow最適化

- 長時間実行のステップ分割
- イベント駆動による効率化
- 適切なタイムアウト設定

## 障害対応

### ヘルスチェック

```
GET /api/v1/health
```

```json
{
  "status": "healthy",
  "version": "1.0.0",
  "database": "connected",
  "workflows": "running"
}
```

### フェイルオーバー

- Cloudflareのグローバルエッジによる自動フェイルオーバー
- D1の自動レプリケーション
- Queue のリトライ機構

### インシデント対応

1. Cloudflare Status Page 確認
2. Workers Logs でエラー調査
3. 必要に応じてロールバック

```bash
# 前バージョンへのロールバック
wrangler rollback --env production
```

## セキュリティ

### ネットワーク

- 全通信HTTPS強制
- Cloudflare WAF有効
- DDoS保護

### アプリケーション

- Cloudflare Access認証必須
- JWT署名検証
- 入力バリデーション
- SQLインジェクション対策（D1 prepared statements）

### データ

- D1データ暗号化（at-rest）
- シークレット管理（Cloudflare Secrets）
- 監査ログ（workflow_events テーブル）

---

_最終更新: 2026年1月24日_

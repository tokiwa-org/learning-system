# エラーハンドリング仕様

## 概要

本ドキュメントは人事考課システムにおけるエラーハンドリングの詳細仕様を定義します。
Neo4jオントロジーのDomainEvent、BusinessEvent、NotificationTypeから派生しています。

## エラー分類体系

### 1. エラーカテゴリ

```
ErrorCategory
├── VALIDATION_ERROR      # 入力バリデーションエラー
├── AUTHENTICATION_ERROR  # 認証エラー
├── AUTHORIZATION_ERROR   # 認可エラー
├── WORKFLOW_ERROR        # ワークフロー状態エラー
├── BUSINESS_RULE_ERROR   # ビジネスルールエラー
├── EXTERNAL_SERVICE_ERROR # 外部サービスエラー
├── DATABASE_ERROR        # データベースエラー
└── SYSTEM_ERROR          # システムエラー
```

### 2. エラーコード体系

```
[カテゴリ]_[サブカテゴリ]_[具体的エラー]

例:
- VALIDATION_SCORE_OUT_OF_RANGE
- WORKFLOW_INVALID_TRANSITION
- AUTH_TOKEN_EXPIRED
```

## エラー定義

### バリデーションエラー (VALIDATION_ERROR)

| エラーコード | HTTPステータス | メッセージ | 発生条件 |
|------------|--------------|----------|---------|
| `VALIDATION_REQUIRED_FIELD` | 400 | 必須項目が入力されていません | 必須フィールドがnull/空 |
| `VALIDATION_SCORE_OUT_OF_RANGE` | 400 | スコアは1〜5の範囲で入力してください | score < 1 or score > 5 |
| `VALIDATION_INVALID_DATE_RANGE` | 400 | 開始日は終了日より前である必要があります | startDate >= endDate |
| `VALIDATION_INVALID_EMAIL` | 400 | メールアドレスの形式が正しくありません | 不正なメール形式 |
| `VALIDATION_EVIDENCE_TOO_LONG` | 400 | エビデンスは1000文字以内で入力してください | evidence.length > 1000 |
| `VALIDATION_COMMENT_REQUIRED` | 400 | コメントは必須です | 差戻し時にコメントなし |
| `VALIDATION_PEER_COUNT_EXCEEDED` | 400 | 同僚評価者は最大5名までです | peerCount > 5 |

### 認証エラー (AUTHENTICATION_ERROR)

| エラーコード | HTTPステータス | メッセージ | 発生条件 |
|------------|--------------|----------|---------|
| `AUTH_TOKEN_MISSING` | 401 | 認証トークンがありません | Authorizationヘッダーなし |
| `AUTH_TOKEN_INVALID` | 401 | 認証トークンが無効です | JWT署名検証失敗 |
| `AUTH_TOKEN_EXPIRED` | 401 | 認証トークンが期限切れです | exp < now |
| `AUTH_CF_ACCESS_FAILED` | 401 | Cloudflare Access認証に失敗しました | CF Access検証失敗 |

### 認可エラー (AUTHORIZATION_ERROR)

| エラーコード | HTTPステータス | メッセージ | 発生条件 |
|------------|--------------|----------|---------|
| `AUTHZ_INSUFFICIENT_ROLE` | 403 | この操作を実行する権限がありません | ロール不足 |
| `AUTHZ_NOT_EVALUATOR` | 403 | この評価サイクルの評価者ではありません | 評価者でない |
| `AUTHZ_NOT_MANAGER` | 403 | この社員の上司ではありません | 上司関係なし |
| `AUTHZ_NOT_HR` | 403 | HR権限が必要です | HRロールなし |
| `AUTHZ_NOT_OWNER` | 403 | 自分のリソースのみ操作可能です | 本人以外のアクセス |
| `AUTHZ_DEPARTMENT_MISMATCH` | 403 | 異なる部署のリソースにはアクセスできません | 部署不一致 |

### ワークフローエラー (WORKFLOW_ERROR)

オントロジーの`WorkflowStatus`遷移ルールに基づく:

| エラーコード | HTTPステータス | メッセージ | 発生条件 |
|------------|--------------|----------|---------|
| `WORKFLOW_INVALID_TRANSITION` | 409 | この状態からの遷移は許可されていません | 不正な状態遷移 |
| `WORKFLOW_ALREADY_SUBMITTED` | 409 | 既に提出済みです | 重複提出 |
| `WORKFLOW_PEER_INCOMPLETE` | 409 | 同僚評価が完了していません | 同僚評価未完了で次へ進行 |
| `WORKFLOW_SELF_NOT_SUBMITTED` | 409 | 自己評価が提出されていません | 自己評価未提出 |
| `WORKFLOW_PERIOD_NOT_ACTIVE` | 409 | 評価期間がアクティブではありません | 期間外操作 |
| `WORKFLOW_ALREADY_FINALIZED` | 409 | 既に確定済みの評価は変更できません | 確定済み変更 |
| `WORKFLOW_REJECTED_RESUBMIT_REQUIRED` | 409 | 差戻しされた評価は再提出が必要です | 差戻し後の操作 |

#### 状態遷移マトリクス

```
現在状態 → 許可される遷移
────────────────────────────────────────────────────────
DRAFT                → SELF_SUBMITTED (submitSelfEvaluation)
SELF_SUBMITTED       → PEER_COMPLETED (completePeerEvaluation)
PEER_COMPLETED       → MANAGER_SUBMITTED (submitManagerEvaluation)
MANAGER_SUBMITTED    → MANAGER_APPROVED (approveByManager)
                     → REJECTED (rejectByManager)
MANAGER_APPROVED     → HR_APPROVED (approveByHR)
                     → REJECTED (rejectByHR)
HR_APPROVED          → FINALIZED (finalize)
REJECTED             → MANAGER_SUBMITTED (resubmit)
```

### ビジネスルールエラー (BUSINESS_RULE_ERROR)

| エラーコード | HTTPステータス | メッセージ | 発生条件 |
|------------|--------------|----------|---------|
| `BUSINESS_SELF_EVALUATION_OWN_ONLY` | 400 | 自分以外の自己評価は提出できません | 他者の自己評価を提出 |
| `BUSINESS_PEER_SELF_EVALUATION` | 400 | 自分自身を同僚評価することはできません | 自己への同僚評価 |
| `BUSINESS_DUPLICATE_PEER` | 400 | 同じ社員への同僚評価は1回のみです | 重複同僚評価 |
| `BUSINESS_ROADMAP_ITEM_INACTIVE` | 400 | 非アクティブなロードマップ項目です | 無効項目への評価 |
| `BUSINESS_GRADE_MISMATCH` | 400 | このロードマップは対象等級外です | 等級不一致 |
| `BUSINESS_SCENARIO_LOCKED` | 400 | シナリオはロック中で編集できません | ロック中編集 |
| `BUSINESS_CURRICULUM_ALREADY_ASSIGNED` | 400 | このカリキュラムは既に配信済みです | 重複配信 |

### 外部サービスエラー (EXTERNAL_SERVICE_ERROR)

| エラーコード | HTTPステータス | メッセージ | 発生条件 |
|------------|--------------|----------|---------|
| `EXTERNAL_AI_GENERATION_FAILED` | 502 | AI生成処理に失敗しました | Cloudflare AI エラー |
| `EXTERNAL_AI_TIMEOUT` | 504 | AI生成がタイムアウトしました | AI処理タイムアウト |
| `EXTERNAL_NOTIFICATION_FAILED` | 502 | 通知送信に失敗しました | 通知サービスエラー |
| `EXTERNAL_SLACK_WEBHOOK_FAILED` | 502 | Slack通知に失敗しました | Slack Webhookエラー |
| `EXTERNAL_EMAIL_FAILED` | 502 | メール送信に失敗しました | メールAPIエラー |

### データベースエラー (DATABASE_ERROR)

| エラーコード | HTTPステータス | メッセージ | 発生条件 |
|------------|--------------|----------|---------|
| `DATABASE_NOT_FOUND` | 404 | 指定されたリソースが見つかりません | レコードなし |
| `DATABASE_CONFLICT` | 409 | データの競合が発生しました | 楽観的ロック失敗 |
| `DATABASE_CONSTRAINT_VIOLATION` | 409 | データ整合性制約違反です | UNIQUE/FK違反 |
| `DATABASE_CONNECTION_FAILED` | 503 | データベース接続に失敗しました | D1接続エラー |

### システムエラー (SYSTEM_ERROR)

| エラーコード | HTTPステータス | メッセージ | 発生条件 |
|------------|--------------|----------|---------|
| `SYSTEM_INTERNAL_ERROR` | 500 | システムエラーが発生しました | 予期しないエラー |
| `SYSTEM_WORKFLOW_ENGINE_ERROR` | 500 | ワークフローエンジンエラー | Workflow実行エラー |
| `SYSTEM_QUEUE_ERROR` | 500 | キュー処理エラー | Queue送信エラー |
| `SYSTEM_MAINTENANCE` | 503 | メンテナンス中です | 計画停止中 |

## エラーレスポンス形式

### 標準エラーレスポンス

```typescript
interface ErrorResponse {
  success: false;
  error: {
    code: string;           // エラーコード (例: "WORKFLOW_INVALID_TRANSITION")
    message: string;        // ユーザー向けメッセージ
    details?: ErrorDetail[];// 詳細情報 (バリデーションエラー等)
    requestId?: string;     // リクエストID (トレーシング用)
    timestamp: string;      // ISO 8601形式
  };
}

interface ErrorDetail {
  field?: string;           // エラーフィールド名
  value?: unknown;          // 入力値
  constraint?: string;      // 制約名
  message: string;          // 詳細メッセージ
}
```

### 例: バリデーションエラー

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力データにエラーがあります",
    "details": [
      {
        "field": "scores[0].score",
        "value": 6,
        "constraint": "max",
        "message": "スコアは1〜5の範囲で入力してください"
      },
      {
        "field": "comment",
        "value": null,
        "constraint": "required",
        "message": "コメントは必須です"
      }
    ],
    "requestId": "req_abc123",
    "timestamp": "2026-01-24T10:30:00.000Z"
  }
}
```

### 例: ワークフローエラー

```json
{
  "success": false,
  "error": {
    "code": "WORKFLOW_INVALID_TRANSITION",
    "message": "この状態からの遷移は許可されていません",
    "details": [
      {
        "field": "status",
        "value": "DRAFT",
        "constraint": "transition",
        "message": "DRAFT → MANAGER_APPROVEDへの遷移は不正です。先に自己評価を提出してください。"
      }
    ],
    "requestId": "req_def456",
    "timestamp": "2026-01-24T10:31:00.000Z"
  }
}
```

## エラーハンドリング実装

### 1. Result型パターン

```typescript
// domain/types/result.ts
type Result<T, E = Error> =
  | { success: true; data: T }
  | { success: false; error: E };

// 使用例
function submitSelfEvaluation(data: SelfEvaluationInput): Result<EvaluationCycle, AppError> {
  // バリデーション
  const validation = validateSelfEvaluation(data);
  if (!validation.success) {
    return { success: false, error: validation.error };
  }

  // ワークフロー状態チェック
  if (cycle.status !== 'DRAFT') {
    return {
      success: false,
      error: new WorkflowError('WORKFLOW_INVALID_TRANSITION', {
        currentStatus: cycle.status,
        attemptedAction: 'submitSelfEvaluation'
      })
    };
  }

  // 処理実行
  // ...

  return { success: true, data: updatedCycle };
}
```

### 2. カスタムエラークラス

```typescript
// domain/errors/app-error.ts
export abstract class AppError extends Error {
  abstract readonly code: string;
  abstract readonly httpStatus: number;
  readonly details?: ErrorDetail[];
  readonly timestamp: string;

  constructor(message: string, details?: ErrorDetail[]) {
    super(message);
    this.details = details;
    this.timestamp = new Date().toISOString();
  }

  toResponse(requestId?: string): ErrorResponse {
    return {
      success: false,
      error: {
        code: this.code,
        message: this.message,
        details: this.details,
        requestId,
        timestamp: this.timestamp
      }
    };
  }
}

// 具体的なエラークラス
export class ValidationError extends AppError {
  readonly code = 'VALIDATION_ERROR';
  readonly httpStatus = 400;
}

export class WorkflowError extends AppError {
  readonly code: string;
  readonly httpStatus = 409;

  constructor(code: string, context: Record<string, unknown>) {
    super(getWorkflowErrorMessage(code, context));
    this.code = code;
  }
}

export class AuthorizationError extends AppError {
  readonly code: string;
  readonly httpStatus = 403;

  constructor(code: string) {
    super(getAuthorizationErrorMessage(code));
    this.code = code;
  }
}

export class NotFoundError extends AppError {
  readonly code = 'DATABASE_NOT_FOUND';
  readonly httpStatus = 404;

  constructor(resource: string, id: string) {
    super(`${resource}が見つかりません: ${id}`);
  }
}

export class ExternalServiceError extends AppError {
  readonly code: string;
  readonly httpStatus: number;

  constructor(code: string, service: string, originalError?: Error) {
    super(`${service}への接続に失敗しました`);
    this.code = code;
    this.httpStatus = code.includes('TIMEOUT') ? 504 : 502;
  }
}
```

### 3. グローバルエラーハンドラー

```typescript
// adapters/in/http/error-handler.ts
import { Context } from 'hono';
import { AppError } from '@/domain/errors/app-error';

export function errorHandler(err: Error, c: Context): Response {
  const requestId = c.get('requestId') || crypto.randomUUID();

  // AppErrorの場合
  if (err instanceof AppError) {
    console.error(`[${requestId}] ${err.code}: ${err.message}`, {
      code: err.code,
      details: err.details,
      stack: err.stack
    });

    return c.json(err.toResponse(requestId), err.httpStatus);
  }

  // 予期しないエラー
  console.error(`[${requestId}] Unexpected error:`, err);

  return c.json({
    success: false,
    error: {
      code: 'SYSTEM_INTERNAL_ERROR',
      message: 'システムエラーが発生しました',
      requestId,
      timestamp: new Date().toISOString()
    }
  }, 500);
}
```

### 4. ワークフロー遷移バリデーター

```typescript
// domain/services/workflow-transition-validator.ts
const ALLOWED_TRANSITIONS: Record<string, { action: string; to: string; actor: string }[]> = {
  'DRAFT': [
    { action: 'submitSelfEvaluation', to: 'SELF_SUBMITTED', actor: 'SELF' }
  ],
  'SELF_SUBMITTED': [
    { action: 'completePeerEvaluation', to: 'PEER_COMPLETED', actor: 'SYSTEM' }
  ],
  'PEER_COMPLETED': [
    { action: 'submitManagerEvaluation', to: 'MANAGER_SUBMITTED', actor: 'MANAGER' }
  ],
  'MANAGER_SUBMITTED': [
    { action: 'approveByManager', to: 'MANAGER_APPROVED', actor: 'MANAGER' },
    { action: 'rejectByManager', to: 'REJECTED', actor: 'MANAGER' }
  ],
  'MANAGER_APPROVED': [
    { action: 'approveByHR', to: 'HR_APPROVED', actor: 'HR' },
    { action: 'rejectByHR', to: 'REJECTED', actor: 'HR' }
  ],
  'HR_APPROVED': [
    { action: 'finalize', to: 'FINALIZED', actor: 'SYSTEM' }
  ],
  'REJECTED': [
    { action: 'resubmit', to: 'MANAGER_SUBMITTED', actor: 'SELF' }
  ]
};

export function validateTransition(
  currentStatus: string,
  action: string,
  actor: string
): Result<string, WorkflowError> {
  const allowed = ALLOWED_TRANSITIONS[currentStatus];

  if (!allowed) {
    return {
      success: false,
      error: new WorkflowError('WORKFLOW_INVALID_TRANSITION', {
        currentStatus,
        action,
        message: '不正なステータスです'
      })
    };
  }

  const transition = allowed.find(t => t.action === action);

  if (!transition) {
    return {
      success: false,
      error: new WorkflowError('WORKFLOW_INVALID_TRANSITION', {
        currentStatus,
        action,
        allowedActions: allowed.map(t => t.action)
      })
    };
  }

  if (transition.actor !== actor && transition.actor !== 'SYSTEM') {
    return {
      success: false,
      error: new WorkflowError('AUTHZ_INSUFFICIENT_ROLE', {
        requiredActor: transition.actor,
        actualActor: actor
      })
    };
  }

  return { success: true, data: transition.to };
}
```

## リトライ戦略

### 外部サービスエラー

```typescript
// infrastructure/retry.ts
interface RetryConfig {
  maxRetries: number;
  baseDelayMs: number;
  maxDelayMs: number;
  retryableErrors: string[];
}

const AI_RETRY_CONFIG: RetryConfig = {
  maxRetries: 3,
  baseDelayMs: 1000,
  maxDelayMs: 10000,
  retryableErrors: ['EXTERNAL_AI_TIMEOUT', 'EXTERNAL_AI_GENERATION_FAILED']
};

const NOTIFICATION_RETRY_CONFIG: RetryConfig = {
  maxRetries: 5,
  baseDelayMs: 500,
  maxDelayMs: 30000,
  retryableErrors: ['EXTERNAL_NOTIFICATION_FAILED', 'EXTERNAL_SLACK_WEBHOOK_FAILED']
};

async function withRetry<T>(
  operation: () => Promise<T>,
  config: RetryConfig
): Promise<T> {
  let lastError: Error;

  for (let attempt = 0; attempt <= config.maxRetries; attempt++) {
    try {
      return await operation();
    } catch (error) {
      lastError = error as Error;

      if (!isRetryable(error, config.retryableErrors)) {
        throw error;
      }

      if (attempt < config.maxRetries) {
        const delay = Math.min(
          config.baseDelayMs * Math.pow(2, attempt),
          config.maxDelayMs
        );
        await sleep(delay);
      }
    }
  }

  throw lastError!;
}
```

## 通知連携

エラー発生時の通知タイプ（オントロジーNotificationTypeから派生）:

| エラーカテゴリ | 通知タイプ | 通知先 |
|--------------|----------|-------|
| WORKFLOW_ERROR | アプリ内通知 | 本人 |
| BUSINESS_RULE_ERROR | アプリ内通知 | 本人 |
| EXTERNAL_SERVICE_ERROR | Slack + メール | システム管理者 |
| DATABASE_ERROR | Slack | システム管理者 |
| SYSTEM_ERROR | Slack + PagerDuty | オンコール担当 |

---

_最終更新: 2026年1月24日_
_派生元: Neo4j Ontology (DomainEvent, NotificationType, WorkflowStatus)_

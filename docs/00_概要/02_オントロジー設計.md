# オントロジー設計

本ドキュメントは、人事考課システムのオントロジー（概念モデル）の構造と、設計書生成のためのCypherクエリを定義します。

---

## 1. オントロジーの役割

```
┌─────────────────────────────────────────────────────────────────┐
│                    Neo4j オントロジー                           │
│                  (Single Source of Truth)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   Domain    │  │   Entity    │  │  Attribute  │             │
│  │  (ドメイン)  │─→│ (エンティティ)│─→│   (属性)    │             │
│  └─────────────┘  └──────┬──────┘  └─────────────┘             │
│                          │                                      │
│         ┌────────────────┼────────────────┐                     │
│         │                │                │                     │
│         ▼                ▼                ▼                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ APIEndpoint │  │   Screen    │  │WorkflowStatus│            │
│  │   (API)     │  │   (画面)    │  │ (ワークフロー)│            │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ DomainEvent │  │Notification │  │EvaluationAxis│            │
│  │(ドメインイベント)│  │Type(通知)   │  │  (評価軸)   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼ 生成
          ┌───────────────────┼───────────────────┐
          │                   │                   │
          ▼                   ▼                   ▼
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │ D1テーブル   │    │  API設計書   │    │  画面設計書  │
   │ (DDL)       │    │             │    │             │
   └─────────────┘    └─────────────┘    └─────────────┘
```

---

## 2. ノード定義

### 2.1 メタモデル（設計構造）

| ノード             | 説明                                   | 主要プロパティ                                     |
| ------------------ | -------------------------------------- | -------------------------------------------------- |
| `Domain`           | ドメイン（境界づけられたコンテキスト） | code, name, boundedContext                         |
| `Entity`           | エンティティ（テーブル）               | code, name, tableName, isAggregate                 |
| `Attribute`        | 属性（カラム）                         | name, type, isPrimaryKey, isRequired, isForeignKey |
| `APIEndpoint`      | APIエンドポイント                      | method, path, permission, requestBody              |
| `Screen`           | 画面                                   | code, name, path, permission, category             |
| `WorkflowStatus`   | ワークフロー状態                       | code, name, order, currentStep, actor              |
| `DomainEvent`      | ドメインイベント                       | code, name, trigger, sideEffects                   |
| `NotificationType` | 通知タイプ                             | code, name, trigger, recipient, channel            |

### 2.2 ビジネスモデル（評価ロジック）

| ノード           | 説明             | 主要プロパティ                                              |
| ---------------- | ---------------- | ----------------------------------------------------------- |
| `EvaluationAxis` | 評価軸           | code, name, weight, maxScore, calculationFormula            |
| `EvaluationRank` | 評価ランク       | code, minScore, maxScore, salaryIncrement                   |
| `RoadmapItem`    | ロードマップ項目 | no, name, category, L1-L5, noiseLevel\*, learningFormat     |
| `Grade`          | 職級             | code, name, level                                           |
| `Category`       | スキルカテゴリ   | code, name, type                                            |

> **注**: `RoadmapItem.noiseLevel` はスキルの複雑性の目安として残しますが、
> 実際のカリキュラム生成時は `Curriculum.noiseLevel` を使用します。

### 2.3 学習・育成モデル

| ノード           | 説明             | 主要プロパティ                                                               |
| ---------------- | ---------------- | ---------------------------------------------------------------------------- |
| `Scenario`       | シナリオ         | code, title, description, targetGrade, learningPhase                         |
| `Curriculum`     | カリキュラム     | code, title, overview, scenarioId, status, **noiseLevel**, noiseDesignNotes  |
| `CurriculumItem` | カリキュラム項目 | order, title, type, content, estimatedMinutes, stepTitle, stepContext        |
| `LearningTask`   | 学習課題         | employeeId, curriculumId, status, dueDate, progress                          |
| `LearningPhase`  | 学習フェーズ     | code, name, description, noiseStrategy                                       |
| `NoiseType`      | ノイズタイプ     | code, name, description, applicablePhases                                    |

> **設計決定**: `noiseLevel`（教育的ノイズレベル）は `Curriculum` に配置します。
> 同じスキルでも学習者のレベルによって異なるノイズ濃度で教えるためです。
> 詳細は [06_ADR_ノイズレベル配置設計](../02_基本設計/06_ADR_ノイズレベル配置設計.md) を参照。

---

## 2.4 教育的ノイズ設計

> 参照: [09_教育的ノイズ.md](../99_参考資料/09_教育的ノイズ.md)、[06_ADR_ノイズレベル配置設計](../02_基本設計/06_ADR_ノイズレベル配置設計.md)

### noiseLevel（ノイズレベル）

`Curriculum.noiseLevel` は学習者のレベルに応じた不確実性・複雑性の度合いを表します。

| 値 | 対象 | ノイズ濃度 | 推奨ノイズタイプ |
|----|------|-----------|-----------------|
| `MINIMAL` | L1（新人） | 最小限 | なし（正解の型を学ぶ） |
| `LOW` | L1→L2 | 10% | information_incomplete |
| `MEDIUM` | L2→L3 | 30% | technical_debt |
| `HIGH` | L3→L4 | 50% | excessive_choices |
| `MAXIMUM` | L4→L5 | 70% | context_fluctuation |

### noiseTypes（ノイズタイプ）

カリキュラムに注入する具体的なノイズの種類：

| 値 | 説明 | 教育効果 |
|----|------|---------|
| `information_incomplete` | 情報の不完全性（仕様の考慮漏れ等） | 批判的思考の育成 |
| `technical_debt` | 技術的負債（レガシーコード等） | 解読力と改善力の育成 |
| `excessive_choices` | 選択肢の過剰（複数の解決策） | 意思決定力の育成 |
| `context_fluctuation` | コンテキストの揺らぎ（途中で変わる要件） | 柔軟性と適応力の育成 |
| `search_pollution` | 検索環境の汚染（古い情報の混在） | 情報リテラシーの育成 |

---

## 3. リレーションシップ定義

| リレーションシップ  | From           | To             | 説明                                   |
| ------------------- | -------------- | -------------- | -------------------------------------- |
| `BELONGS_TO_DOMAIN` | Entity         | Domain         | エンティティのドメイン所属             |
| `HAS_ATTRIBUTE`     | Entity         | Attribute      | エンティティの属性                     |
| `HAS_API`           | Entity         | APIEndpoint    | エンティティのCRUD API                 |
| `REFERENCES`        | Entity         | Entity         | エンティティ間の参照（FK）             |
| `PART_OF_AGGREGATE` | Entity         | Entity         | 集約の構成要素                         |
| `DISPLAYS`          | Screen         | Entity         | 画面で表示するエンティティ             |
| `CAN_TRANSITION_TO` | WorkflowStatus | WorkflowStatus | 状態遷移                               |
| `BELONGS_TO`        | RoadmapItem    | Category       | ロードマップのカテゴリ所属             |
| `GENERATED_FROM`    | Curriculum     | Scenario       | カリキュラムの生成元シナリオ           |
| `COVERS`            | Curriculum     | RoadmapItem    | カリキュラムが対応するロードマップ項目 |
| `TARGETS`           | Scenario       | Grade          | シナリオの対象職級                     |
| `ASSIGNED_TO`       | LearningTask   | Employee       | 学習課題の割り当て先                   |
| `BASED_ON`          | LearningTask   | Curriculum     | 学習課題の元カリキュラム               |
| `ACHIEVES`          | LearningTask   | RoadmapItem    | 学習完了で習得するロードマップ項目     |

---

## 4. 設計書生成クエリ

### 4.1 D1テーブル定義（DDL）生成

```cypher
// 全テーブルのDDL生成
MATCH (e:Entity)-[ha:HAS_ATTRIBUTE]->(a:Attribute)
WITH e, a, ha.order as ord
ORDER BY e.tableName, ord
WITH e.tableName as tableName, e.code as entityCode, collect({
  name: a.name,
  type: a.type,
  isPrimaryKey: coalesce(a.isPrimaryKey, false),
  isRequired: coalesce(a.isRequired, false),
  isForeignKey: coalesce(a.isForeignKey, false),
  defaultValue: a.defaultValue,
  allowedValues: a.allowedValues
}) as columns
RETURN tableName, entityCode, columns
ORDER BY tableName
```

### 4.2 API一覧生成

```cypher
// 全API一覧
MATCH (e:Entity)-[:HAS_API]->(a:APIEndpoint)
RETURN a.method as method,
       a.path as path,
       a.name as name,
       a.permission as permission,
       e.code as entity,
       a.requestBody as requestBody,
       a.queryParams as queryParams,
       a.triggersTransition as triggersTransition
ORDER BY a.path, a.method
```

### 4.3 ワークフロー状態遷移図生成

```cypher
// 状態遷移一覧
MATCH (s1:WorkflowStatus)-[t:CAN_TRANSITION_TO]->(s2:WorkflowStatus)
RETURN s1.code as fromStatus,
       s1.name as fromName,
       t.action as action,
       t.apiEndpoint as apiEndpoint,
       s2.code as toStatus,
       s2.name as toName,
       s1.actor as actor
ORDER BY s1.order, s2.order
```

### 4.4 画面一覧生成

```cypher
// 画面一覧（関連エンティティ付き）
MATCH (s:Screen)
OPTIONAL MATCH (s)-[:DISPLAYS]->(e:Entity)
WITH s, collect(e.code) as entities
RETURN s.code as screenCode,
       s.name as screenName,
       s.path as path,
       s.permission as permission,
       s.category as category,
       s.description as description,
       entities as relatedEntities
ORDER BY s.code
```

### 4.5 ドメインモデル図生成

```cypher
// ドメインとエンティティの関係
MATCH (d:Domain)<-[:BELONGS_TO_DOMAIN]-(e:Entity)
OPTIONAL MATCH (e)-[r:REFERENCES]->(e2:Entity)
RETURN d.code as domain,
       d.name as domainName,
       collect(DISTINCT {
         entity: e.code,
         name: e.name,
         isAggregate: e.isAggregate,
         tableName: e.tableName
       }) as entities,
       collect(DISTINCT {
         from: e.code,
         to: e2.code,
         foreignKey: r.foreignKey
       }) as references
```

### 4.6 評価ロジック生成

```cypher
// 評価軸とスコア計算
MATCH (a:EvaluationAxis)
RETURN a.code as axisCode,
       a.name as axisName,
       a.weight as weight,
       a.maxScore as maxScore,
       a.roadmapRange as roadmapRange,
       a.calculationFormula as formula,
       a.evaluator as evaluator
ORDER BY a.weight DESC
```

```cypher
// ランク判定ロジック
MATCH (r:EvaluationRank)
RETURN r.code as rank,
       r.name as rankName,
       r.minScore as minScore,
       r.maxScore as maxScore,
       r.salaryIncrement as salaryIncrement,
       r.description as description
ORDER BY r.minScore DESC
```

### 4.7 通知設計生成

```cypher
// 通知タイプ一覧
MATCH (n:NotificationType)
RETURN n.code as code,
       n.name as name,
       n.trigger as trigger,
       n.recipient as recipient,
       n.channel as channel,
       n.template as template
ORDER BY n.code
```

### 4.8 ドメインイベント一覧

```cypher
// ドメインイベント一覧
MATCH (e:DomainEvent)
RETURN e.code as eventCode,
       e.name as eventName,
       e.trigger as trigger,
       e.statusChange as statusChange,
       e.sideEffects as sideEffects
ORDER BY e.code
```

---

## 5. オントロジー統計

```cypher
// オントロジー統計
MATCH (d:Domain) WITH count(d) as domains
MATCH (e:Entity) WITH domains, count(e) as entities
MATCH (a:Attribute) WITH domains, entities, count(a) as attributes
MATCH (api:APIEndpoint) WITH domains, entities, attributes, count(api) as apis
MATCH (s:Screen) WITH domains, entities, attributes, apis, count(s) as screens
MATCH (w:WorkflowStatus) WITH domains, entities, attributes, apis, screens, count(w) as statuses
MATCH (de:DomainEvent) WITH domains, entities, attributes, apis, screens, statuses, count(de) as events
MATCH (n:NotificationType) WITH domains, entities, attributes, apis, screens, statuses, events, count(n) as notifications

RETURN {
  domains: domains,
  entities: entities,
  attributes: attributes,
  apiEndpoints: apis,
  screens: screens,
  workflowStatuses: statuses,
  domainEvents: events,
  notificationTypes: notifications
} as stats
```

---

## 6. オントロジー更新ガイドライン

### 6.1 新しいエンティティを追加する場合

```cypher
// 1. Entityノードを作成
CREATE (e:Entity {
  code: 'NewEntity',
  name: '新エンティティ',
  description: '説明',
  isAggregate: false,
  tableName: 'new_entities'
})

// 2. ドメインに関連付け
MATCH (d:Domain {code: 'EVALUATION'}), (e:Entity {code: 'NewEntity'})
CREATE (e)-[:BELONGS_TO_DOMAIN]->(d)

// 3. 属性を追加
MATCH (e:Entity {code: 'NewEntity'})
CREATE (a:Attribute {name: 'id', type: 'TEXT', isPrimaryKey: true, isRequired: true})
CREATE (e)-[:HAS_ATTRIBUTE {order: 1}]->(a)

// 4. APIを追加
MATCH (e:Entity {code: 'NewEntity'})
CREATE (api:APIEndpoint {method: 'GET', path: '/new-entities', permission: 'ALL'})
CREATE (e)-[:HAS_API]->(api)
```

### 6.2 状態遷移を追加する場合

```cypher
// 新しい遷移を追加
MATCH (s1:WorkflowStatus {code: 'FROM_STATUS'}),
      (s2:WorkflowStatus {code: 'TO_STATUS'})
CREATE (s1)-[:CAN_TRANSITION_TO {
  action: 'newAction',
  apiEndpoint: 'POST /new-action'
}]->(s2)
```

---

## 7. 整合性検証クエリ

```cypher
// 孤立したエンティティ（ドメインに属していない）
MATCH (e:Entity)
WHERE NOT (e)-[:BELONGS_TO_DOMAIN]->(:Domain)
RETURN e.code as orphanedEntity

// APIのないエンティティ
MATCH (e:Entity)
WHERE NOT (e)-[:HAS_API]->(:APIEndpoint)
AND e.isAggregate = true
RETURN e.code as entityWithoutAPI

// 属性のないエンティティ
MATCH (e:Entity)
WHERE NOT (e)-[:HAS_ATTRIBUTE]->(:Attribute)
RETURN e.code as entityWithoutAttributes
```

---

_トキワテック人事考課システム 2026年度版_
